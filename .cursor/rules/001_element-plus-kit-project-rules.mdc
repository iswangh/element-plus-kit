---
description: Element Plus Kit Monorepo 项目开发规范
globs: 
alwaysApply: true
---

# Element Plus Kit Monorepo 项目开发规范

本文档基于通用前端开发规范，结合 Element Plus Kit 项目的 Monorepo 架构特点，制定项目特定的开发规则和最佳实践。

---

## 项目架构概述

### Monorepo 结构
- **包管理工具**：pnpm workspace
- **包结构**：
  - `packages/core`：核心工具函数包（无 Vue 组件）
  - `packages/form`：表单组件包（依赖 core）
  - `packages/kit`：主包，聚合所有组件和工具（依赖 form 和 core）
  - `playground`：本地开发测试环境
- **技术栈**：Vue 3 + TypeScript + Vite + Element Plus
- **模块系统**：ES Module（`type: "module"`）

### 包依赖关系
```
core (独立包)
  ↓
form (依赖 core)
  ↓
kit (依赖 form 和 core)
```

---

## 开发环境配置

### Node.js 版本管理
- **必须使用 Volta 管理 Node.js 版本**
- **当前版本**：Node.js 25.1.0（在 `package.json` 的 `volta.node` 中指定）
- **版本要求**：`^20.19.0 || >=22.12.0`（在 `package.json` 的 `engines` 中指定）
- **检查方式**：执行 `volta --version` 确认 Volta 已安装
- **自动切换**：Volta 会根据项目配置自动切换到正确的 Node.js 版本

### 包管理器
- **必须使用 pnpm**：项目使用 pnpm workspace 管理 Monorepo
- **锁文件**：`pnpm-lock.yaml`（必须提交到版本控制）
- **安装依赖**：使用 `pnpm install`（不要使用 npm 或 yarn）
- **工作区配置**：`pnpm-workspace.yaml` 定义了工作区包

### 开发工具
- **代码规范**：ESLint（基于 @antfu/eslint-config）
- **类型检查**：TypeScript + vue-tsc
- **构建工具**：Vite
- **Git Hooks**：Husky + lint-staged
- **提交规范**：Commitlint（Conventional Commits）

---

## Monorepo 开发规范

### 包命名规范
- **Scoped Package**：所有包使用 `@iswangh/element-plus-kit` 作用域
- **命名格式**：
  - `@iswangh/element-plus-kit/core`
  - `@iswangh/element-plus-kit/form`
  - `@iswangh/element-plus-kit`（主包，无后缀）

### 包导入规范
- **必须使用包名导入**：在代码中使用包名而不是相对路径
  ```typescript
  // ✅ 正确
  import { checkCondition } from '@iswangh/element-plus-kit/core'
  import { WForm } from '@iswangh/element-plus-kit/form'
  
  // ❌ 错误
  import { checkCondition } from '@/core'
  import { WForm } from '../../packages/form/src/index'
  ```
- **路径别名限制**：仅在 `tsconfig.app.json` 中配置，用于根目录类型解析，不在包内部使用

### 包依赖管理
- **内部依赖**：使用 `workspace:*` 协议
  ```json
  {
    "dependencies": {
      "@iswangh/element-plus-kit/core": "workspace:*"
    }
  }
  ```
- **外部依赖**：使用 `peerDependencies` 声明（如 Vue、Element Plus）
- **开发依赖**：统一放在 `devDependencies` 中

### 包构建规范
- **构建命令**：
  - 单个包：`cd packages/core && pnpm build`
  - 所有包：`pnpm build:packages`（根目录）
  - 完整流程：`pnpm build`（类型检查 + 构建）
- **构建产物**：
  - 输出目录：`packages/*/dist/`
  - 包含文件：`.js`、`.d.ts`、`.d.ts.map`
  - 样式文件：`packages/form/dist/style.css`
- **构建前检查**：发布前自动执行 `prepublishOnly`（构建 + 类型检查）

### TypeScript 配置规范
- **项目引用**：使用 TypeScript Project References 管理包之间的类型依赖
- **配置继承**：
  - 根目录：`tsconfig.app.json`（基础配置）
  - 各包：继承 `tsconfig.app.json`，启用 `composite: true`
  - Playground：继承 `tsconfig.app.json`，不启用 `composite`
- **类型定义**：
  - 通过 `package.json` 的 `exports.types` 字段导出
  - 构建时自动生成（使用 `vite-plugin-dts`）
  - 类型文件位于 `dist/` 目录

---

## 代码开发规范

### Vue 组件规范
- **单文件组件**：必须使用 `<script setup lang="ts">`
  ```vue
  <script setup lang="ts">
  // 组件逻辑
  </script>
  ```
- **组件命名**：使用 PascalCase（如 `WForm`、`FormItem`）
- **Props 定义**：使用 `defineProps` 和 TypeScript 类型
  ```typescript
  interface Props {
    modelValue: string
    required?: boolean
  }
  
  const props = defineProps<Props>()
  ```
- **Emits 定义**：使用 `defineEmits` 和 TypeScript 类型
  ```typescript
  interface Emits {
    (e: 'update:modelValue', value: string): void
  }
  
  const emit = defineEmits<Emits>()
  ```

### TypeScript 类型规范
- **类型推断优先**：充分利用类型推断，避免不必要的类型注解
- **类型导出**：在包的 `src/types.ts` 或 `src/index.ts` 中统一导出类型
- **类型命名**：使用 PascalCase（如 `FormItems`、`FormConfig`）
- **接口优先**：优先使用 `interface` 定义对象类型，便于扩展
- **类型安全**：启用严格模式，充分利用类型系统

### 文件组织规范
- **包目录结构**：
  ```
  packages/[package-name]/
  ├── src/
  │   ├── index.ts          # 主入口，统一导出
  │   ├── types.ts          # 类型定义（可选）
  │   └── [components]/     # 组件或工具函数
  ├── dist/                 # 构建产物（不提交）
  ├── package.json
  ├── tsconfig.json
  ├── vite.config.ts
  └── README.md
  ```
- **模块入口**：每个模块必须有 `index.ts` 作为聚合导出入口
- **文件命名**：
  - TypeScript 文件：`camelCase.ts`（如 `checkCondition.ts`）
  - Vue 组件：`PascalCase.vue`（如 `FormItem.vue`）
  - 配置文件：`kebab-case.config.ts`（如 `vite.config.ts`）

### 导出规范
- **统一导出**：通过 `src/index.ts` 统一导出所有公共 API
  ```typescript
  // packages/core/src/index.ts
  export { checkCondition } from './utils/checkCondition'
  export type { CheckCondition } from './utils/checkCondition'
  ```
- **类型导出**：类型和值分开导出，使用 `export type` 导出类型
- **默认导出**：避免使用默认导出，优先使用命名导出

---

## 构建和发布规范

### 构建流程
1. **开发时构建**：
   ```bash
   # 单个包监听模式
   cd packages/core && pnpm dev
   
   # 所有包构建
   pnpm build:packages
   ```
2. **生产构建**：
   ```bash
   # 完整流程（类型检查 + 构建）
   pnpm build
   ```
3. **类型检查**：
   ```bash
   # 检查所有包的类型
   pnpm type-check
   ```

### 发布流程
- **发布顺序**：必须按照依赖顺序发布（core → form → kit）
- **发布命令**：
  - 单个包：`pnpm publish:core`、`pnpm publish:form`、`pnpm publish:kit`
  - 所有包：`pnpm publish:all`
- **发布前检查**：
  - 自动执行 `prepublishOnly`（构建 + 类型检查）
  - 确保版本号已更新
  - 确保依赖版本已更新（如果被依赖包版本变化）

### 版本管理
- **版本策略**：独立版本（每个包独立管理版本号）
- **版本格式**：遵循语义化版本（SemVer）
- **版本更新**：使用 `npm version patch/minor/major` 更新版本

---

## 代码质量规范

### ESLint 规则
- **配置文件**：`eslint.config.js`
- **基础配置**：基于 @antfu/eslint-config
- **查看配置**：运行 `pnpm eslint:inspect` 查看完整的 ESLint 配置
- **代码检查**：运行 `pnpm lint` 检查代码规范
- **自动修复**：运行 `pnpm lint:fix` 自动修复可修复的问题

### Git 提交规范
- **配置文件**：`commitlint.config.js`
- **提交格式**：遵循 Conventional Commits 规范
- **提交检查**：通过 Husky Git Hook 自动检查提交信息格式
- **作用域（scope）**：建议使用包名（如 `core`、`form`、`kit`）

### 代码审查规范
- **提交前检查**：
  - 运行 `pnpm lint` 检查代码规范
  - 运行 `pnpm type-check` 检查类型错误
  - 运行 `pnpm build` 确保构建成功
- **代码质量**：
  - 遵循 DRY 原则（Don't Repeat Yourself）
  - 保持代码简洁（KISS 原则）
  - 确保类型安全
  - 添加必要的 JSDoc 注释

---

## 文档规范

### 包文档
- **README.md**：每个包必须包含 README.md，说明：
  - 包的功能和用途
  - 安装和使用方法
  - API 文档链接
  - 示例代码
- **DEVELOPMENT.md**：详细的开发文档（可选），说明：
  - 配置详解
  - 开发流程
  - 常见问题

### 代码注释
- **JSDoc 标准**：所有公共 API 必须使用 JSDoc 注释
- **注释内容**：
  - 函数/方法：说明功能、参数、返回值
  - 类型定义：说明用途和字段含义
  - 复杂逻辑：说明实现思路和注意事项

---

## 测试规范

### 测试文件组织
- **测试文件位置**：与源文件同目录或 `__tests__` 目录
- **测试文件命名**：`*.test.ts` 或 `*.spec.ts`
- **测试框架**：Vitest（已配置但未使用）

### 测试要求
- **单元测试**：核心功能必须有单元测试
- **组件测试**：Vue 组件使用 @vue/test-utils 进行测试
- **类型测试**：通过 TypeScript 类型检查确保类型安全

---

## 性能优化规范

### 构建优化
- **代码分割**：按需导入，避免全量导入
- **Tree Shaking**：确保构建工具能够正确进行 Tree Shaking
- **外部依赖**：使用 `external` 配置，避免打包外部依赖

### 运行时优化
- **按需导入**：组件库支持按需导入
- **懒加载**：大型组件支持懒加载
- **缓存策略**：合理使用缓存提升性能

---

## 常见问题和注意事项

### 类型解析问题
- **问题**：找不到模块或类型定义
- **解决**：确保已构建所有包（`pnpm build:packages`）
- **原因**：TypeScript 需要通过 `package.json` 的 `exports.types` 解析类型

### 依赖版本问题
- **问题**：workspace 依赖在发布时需要具体版本
- **解决**：pnpm publish 会自动处理，或使用发布工具（如 changesets）

### 构建顺序问题
- **问题**：包之间依赖导致构建失败
- **解决**：按照依赖顺序构建（core → form → kit）
- **工具**：使用 `pnpm build:packages` 自动处理依赖顺序

---

## 工具和命令速查

### 常用命令
```bash
# 安装依赖
pnpm install

# 构建所有包
pnpm build:packages

# 类型检查 + 构建
pnpm build

# 类型检查
pnpm type-check

# 代码检查
pnpm lint

# 修复代码问题
pnpm lint:fix

# 开发模式（构建包 + 启动服务器）
pnpm dev

# 发布包
pnpm publish:core
pnpm publish:form
pnpm publish:kit
pnpm publish:all
```

### 包内命令
```bash
# 进入包目录
cd packages/core

# 开发模式（监听）
pnpm dev

# 构建
pnpm build

# 类型检查
pnpm type-check
```

---

## 更新日志

- **2024-12**：初始版本，基于通用前端规范和项目特点制定
